#!/bin/bash
################################################################################
# Protei_Bulk - Start Script
# Starts the Protei_Bulk application service
################################################################################

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR="$(dirname "$SCRIPT_DIR")"
BIN_DIR="$BASE_DIR/bin"
LOG_DIR="$BASE_DIR/logs"
CONFIG_DIR="$BASE_DIR/config"
PID_FILE="$BASE_DIR/tmp/protei_bulk.pid"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Application details
APP_NAME="Protei_Bulk"
APP_BIN="$BIN_DIR/Protei_Bulk"
STARTUP_LOG="$LOG_DIR/startup.log"

echo "========================================"
echo "  Starting $APP_NAME"
echo "========================================"

# Check if already running
if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo -e "${YELLOW}Warning: $APP_NAME is already running (PID: $PID)${NC}"
        exit 1
    else
        echo "Removing stale PID file..."
        rm -f "$PID_FILE"
    fi
fi

# Check if binary exists
if [ ! -f "$APP_BIN" ]; then
    echo -e "${RED}Error: Binary not found at $APP_BIN${NC}"
    exit 1
fi

# Check if binary is executable
if [ ! -x "$APP_BIN" ]; then
    echo "Making binary executable..."
    chmod +x "$APP_BIN"
fi

# Check license
if [ ! -f "$CONFIG_DIR/license.key" ]; then
    echo -e "${RED}Error: License file not found at $CONFIG_DIR/license.key${NC}"
    exit 1
fi

# Create necessary directories
mkdir -p "$LOG_DIR" "$BASE_DIR/tmp" "$BASE_DIR/cdr"

# Set library path
export LD_LIBRARY_PATH="$BASE_DIR/lib:$LD_LIBRARY_PATH"
export PYTHONPATH="$BASE_DIR/lib:$PYTHONPATH"

# Start application
echo "Starting $APP_NAME..."
echo "Base Directory: $BASE_DIR"
echo "Startup Log: $STARTUP_LOG"
echo ""

# Start in background and capture PID
nohup "$APP_BIN" >> "$STARTUP_LOG" 2>&1 &
APP_PID=$!

# Save PID
echo $APP_PID > "$PID_FILE"

# Wait a moment and check if process is running
sleep 2

if ps -p "$APP_PID" > /dev/null 2>&1; then
    echo -e "${GREEN}✓ $APP_NAME started successfully${NC}"
    echo "PID: $APP_PID"
    echo "PID file: $PID_FILE"
    echo ""
    echo "Use 'scripts/status' to check status"
    echo "Use 'scripts/stop' to stop the service"
    echo "Use 'tail -f $STARTUP_LOG' to view startup logs"
    exit 0
else
    echo -e "${RED}✗ Failed to start $APP_NAME${NC}"
    echo "Check logs at: $STARTUP_LOG"
    rm -f "$PID_FILE"
    exit 1
fi
