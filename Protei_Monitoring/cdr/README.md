# cdr/ - Call Detail Records Output

This directory contains CDR (Call Detail Record) files generated by the monitoring system.

## Directory Structure

CDRs are organized by protocol:

```
cdr/
├── MAP/           # MAP protocol CDRs
├── CAP/           # CAP protocol CDRs
├── INAP/          # INAP protocol CDRs
├── Diameter/      # Diameter protocol CDRs
├── GTP/           # GTP protocol CDRs
├── PFCP/          # PFCP protocol CDRs
├── HTTP2/         # HTTP/2 (5G SBI) CDRs
├── NGAP/          # NGAP (5G RAN) CDRs
├── S1AP/          # S1AP (4G RAN) CDRs
├── NAS/           # NAS (4G/5G) CDRs
└── combined/      # All protocols combined
```

## CDR File Naming Convention

```
YYYYMMDD_HHMMSS_<protocol>_<type>.cdr

Examples:
20251114_103045_MAP_location_update.cdr
20251114_103045_Diameter_authentication.cdr
20251114_103045_GTP_data_session.cdr
```

## CDR Format

CDRs are generated in CSV format by default:

```csv
timestamp,transaction_id,protocol,event_type,imsi,msisdn,source_ip,dest_ip,result,duration_ms,details
2025-11-14 10:30:45,TID-123456,MAP,Location Update,123456789012345,+1234567890,192.168.1.1,192.168.1.2,Success,234,"Update Location completed successfully"
```

## CDR Configuration

Configure CDR generation in `config/protocols.cfg`:

```bash
# Enable/disable CDR generation per protocol
MAP_SAVE_CDR=true
CAP_SAVE_CDR=true
# ... etc

# CDR format (csv, json, xml)
CDR_FORMAT="csv"

# CDR rotation
CDR_ROTATION_SIZE_MB=100      # Rotate when file reaches size
CDR_ROTATION_INTERVAL=3600    # Rotate every hour (seconds)

# CDR retention
CDR_RETENTION_DAYS=90         # Keep CDRs for 90 days
CDR_COMPRESS_OLD=true          # Compress rotated files
```

## Accessing CDRs

### Via Web Interface

1. Go to: **Analytics → Reports → CDR Export**
2. Select protocol and date range
3. Click "Export" → Download CSV/JSON/XML

### Via Filesystem

```bash
# View recent MAP CDRs
tail -100 cdr/MAP/*.cdr

# Search for specific IMSI
grep "123456789012345" cdr/MAP/*.cdr

# Count total CDRs today
wc -l cdr/MAP/$(date +%Y%m%d)*.cdr
```

### Via API

```bash
# Export CDRs via API
curl "http://localhost:8080/api/cdr/export?protocol=MAP&date=2025-11-14" \
  -H "Authorization: Bearer <token>" \
  -o map_cdrs.csv
```

## CDR Retention and Cleanup

CDRs are automatically cleaned up based on retention policy:

```bash
# Manual cleanup (delete CDRs older than 90 days)
find cdr/ -name "*.cdr" -mtime +90 -delete

# Compress old CDRs
find cdr/ -name "*.cdr" -mtime +7 -exec gzip {} \;

# Archive to external storage
tar -czf /backup/cdr_$(date +%Y%m).tar.gz cdr/
```

## CDR Analysis

### Common CDR Queries

**Find all location updates for a subscriber:**
```bash
grep "Location Update" cdr/MAP/*.cdr | grep "123456789012345"
```

**Count failed sessions today:**
```bash
grep "Failed" cdr/*/$(date +%Y%m%d)*.cdr | wc -l
```

**Find sessions with high duration:**
```bash
awk -F',' '$9 > 5000' cdr/GTP/*.cdr  # Duration > 5 seconds
```

## Disk Space Management

**Check CDR disk usage:**
```bash
du -sh cdr/
du -sh cdr/*/

# Detailed breakdown
du -h cdr/* | sort -h
```

**Estimated disk usage:**
- **MAP**: ~10 MB/day (typical)
- **Diameter**: ~50 MB/day (high volume)
- **GTP**: ~200 MB/day (very high volume)
- **Others**: ~5-20 MB/day each

**Total**: ~300-500 MB/day for all protocols

## Integration with External Systems

### Export to SFTP Server

```bash
# Upload CDRs to remote server
scp cdr/MAP/$(date +%Y%m%d)*.cdr user@server:/path/to/cdr/

# Automated via cron
0 2 * * * /usr/protei/Protei_Monitoring/scripts/utils/export_cdr.sh
```

### Import to Database

```bash
# Import CDRs to PostgreSQL
psql -h localhost -U protei -d cdr_db -c "\COPY cdr_table FROM 'cdr/MAP/20251114_*.cdr' DELIMITER ',' CSV HEADER"
```

### Send to Kafka/Splunk

Integration scripts available in `scripts/utils/`.

## Troubleshooting

**Issue: No CDRs being generated**

```bash
# 1. Check CDR is enabled
grep SAVE_CDR config/protocols.cfg

# 2. Check disk space
df -h cdr/

# 3. Check write permissions
ls -la cdr/

# 4. Check logs
grep CDR logs/application/*.log
```

**Issue: CDR files too large**

```bash
# Reduce rotation size
nano config/protocols.cfg
# Set: CDR_ROTATION_SIZE_MB=50

# Reload configuration
../scripts/reload
```

## See Also

- [Analytics & Reporting](../document/ANALYTICS_REPORTING.md)
- [Configuration Guide](../document/CONFIGURATION_GUIDE.md)
- [Storage Management](../document/STORAGE_MANAGEMENT.md)
