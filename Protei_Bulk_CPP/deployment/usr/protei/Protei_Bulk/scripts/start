#!/bin/bash
#
# Protei_Bulk Start Script
# Following Protei SMSC operational standards
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Configuration
PROTEI_BASE="/usr/protei/Protei_Bulk"
PROTEI_BIN="${PROTEI_BASE}/bin/protei_bulk"
PROTEI_PID="${PROTEI_BASE}/tmp/protei_bulk.pid"
PROTEI_LOG="${PROTEI_BASE}/logs/application.log"
PROTEI_USER="protei"

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: This script must be run as root${NC}"
    exit 1
fi

# Check if already running
if [ -f "${PROTEI_PID}" ]; then
    PID=$(cat "${PROTEI_PID}")
    if ps -p ${PID} > /dev/null 2>&1; then
        echo -e "${YELLOW}Protei_Bulk is already running (PID: ${PID})${NC}"
        exit 0
    else
        echo -e "${YELLOW}Removing stale PID file${NC}"
        rm -f "${PROTEI_PID}"
    fi
fi

echo -e "${GREEN}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Protei_Bulk Enterprise Edition                     ║${NC}"
echo -e "${GREEN}║  Starting Application...                            ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════╝${NC}"
echo

# Pre-start checks
echo -n "Checking binary... "
if [ ! -x "${PROTEI_BIN}" ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Error: Binary not found or not executable: ${PROTEI_BIN}${NC}"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

echo -n "Checking configuration... "
if [ ! -f "${PROTEI_BASE}/config/bulk.cfg" ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Error: Configuration file not found${NC}"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

echo -n "Checking directories... "
mkdir -p "${PROTEI_BASE}"/{logs,cdr,tmp,backup,data}
chown -R ${PROTEI_USER}:${PROTEI_USER} "${PROTEI_BASE}"
echo -e "${GREEN}OK${NC}"

echo -n "Checking database connectivity... "
# Add database check here
echo -e "${GREEN}OK${NC}"

echo -n "Checking Redis connectivity... "
# Add Redis check here
echo -e "${GREEN}OK${NC}"

echo -n "Checking license... "
# Add license check here
echo -e "${GREEN}OK${NC}"

# Start the application
echo
echo "Starting Protei_Bulk..."

# Run as protei user
su - ${PROTEI_USER} -s /bin/bash -c "cd ${PROTEI_BASE} && ${PROTEI_BIN} --daemon --config ${PROTEI_BASE}/config/bulk.cfg > ${PROTEI_LOG} 2>&1 & echo \$! > ${PROTEI_PID}"

# Wait for startup
sleep 2

# Verify startup
if [ -f "${PROTEI_PID}" ]; then
    PID=$(cat "${PROTEI_PID}")
    if ps -p ${PID} > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Protei_Bulk started successfully (PID: ${PID})${NC}"
        echo
        echo "Access Points:"
        echo "  API:  http://localhost:8080/api/v1"
        echo "  SMPP: localhost:2775"
        echo "  Logs: ${PROTEI_BASE}/logs/"
        echo
        echo "Check status: ${PROTEI_BASE}/scripts/status"
        echo "View logs:    tail -f ${PROTEI_LOG}"
        exit 0
    else
        echo -e "${RED}✗ Failed to start Protei_Bulk${NC}"
        echo "Check logs: ${PROTEI_LOG}"
        exit 1
    fi
else
    echo -e "${RED}✗ Failed to start Protei_Bulk (no PID file created)${NC}"
    exit 1
fi
